/*
 * Licensed under the MIT license:
 * http://www.opensource.org/licenses/mit-license.php
 *
 */

Raphael.fn.freeTransform=function(e,m,n){function l(b){if(b&&a.opts.dragSnap){var c=b.x,h=b.y,g={x:0,y:0},d=0,e=0;[0,1].map(function(){g.x=c-Math.round(c/a.opts.dragSnap)*a.opts.dragSnap;g.y=h-Math.round(h/a.opts.dragSnap)*a.opts.dragSnap;Math.abs(g.x)<=a.opts.dragSnapDist&&(d=g.x);Math.abs(g.y)<=a.opts.dragSnapDist&&(e=g.y);c+=b.width-d;h+=b.height-e});a.attrs.translate.x-=d;a.attrs.translate.y-=e}if(a.opts.boundary){var f=a.opts.boundary;a.attrs.center.x+a.attrs.translate.x<f.x&&(a.attrs.translate.x+=
f.x-(a.attrs.center.x+a.attrs.translate.x));a.attrs.center.y+a.attrs.translate.y<f.y&&(a.attrs.translate.y+=f.y-(a.attrs.center.y+a.attrs.translate.y));a.attrs.center.x+a.attrs.translate.x>f.x+f.width&&(a.attrs.translate.x+=f.x+f.width-(a.attrs.center.x+a.attrs.translate.x));a.attrs.center.y+a.attrs.translate.y>f.y+f.height&&(a.attrs.translate.y+=f.y+f.height-(a.attrs.center.y+a.attrs.translate.y))}a.opts.keepRatio&&(a.attrs.scale.x=a.attrs.scale.y);g=Math.abs(a.attrs.rotate%a.opts.rotateSnap);g=
Math.min(g,a.opts.rotateSnap-g);g<a.opts.rotateSnapDist&&(a.attrs.rotate=Math.round(a.attrs.rotate/a.opts.rotateSnap)*a.opts.rotateSnap);a.opts.scaleSnap&&(a.attrs.scale.x=Math.round(a.attrs.scale.x*a.attrs.size.x/a.opts.scaleSnap)*a.opts.scaleSnap/a.attrs.size.x,a.attrs.scale.y=Math.round(a.attrs.scale.y*a.attrs.size.y/a.opts.scaleSnap)*a.opts.scaleSnap/a.attrs.size.y);if(a.opts.rotateRange&&(f=(360+a.attrs.rotate)%360,180<f&&(f-=360),f<a.opts.rotateRange[0]&&(a.attrs.rotate+=a.opts.rotateRange[0]-
f),f>a.opts.rotateRange[1]))a.attrs.rotate+=a.opts.rotateRange[1]-f}function k(a){var c={},h;for(h in a)c[h]="object"==typeof a[h]?k(a[h]):a[h];return c}function i(b){if(a.callback){var c=[];b.map(function(a){a&&c.push(a)});clearTimeout(o);setTimeout(function(){a.callback&&a.callback(a,c)},1)}}if(e.freeTransform)return e.freeTransform;"map"in Array.prototype||(Array.prototype.map=function(a,c){var h=[],g;for(g in this)this.hasOwnProperty(g)&&(h[g]=a.call(c,this[g],g,this));return h});var d=this,j=
e.getBBox(!0),a=e.freeTransform={attrs:{x:j.x,y:j.y,size:{x:j.width,y:j.height},center:{x:j.x+j.width/2,y:j.y+j.height/2},rotate:0,scale:{x:1,y:1},translate:{x:0,y:0}},axes:null,bbox:null,callback:null,items:[],handles:{center:null,x:null,y:null},offset:{rotate:0,scale:{x:1,y:1},translate:{x:0,y:0}},opts:{attrs:{fill:"#000",stroke:"#000"},boundary:{x:d._left?d._left:0,y:d._top?d._top:0,width:d.width,height:d.height},distance:1.2,drag:!0,dragRotate:!1,dragScale:!1,dragSnap:!1,dragSnapDist:0,keepRatio:!1,
rotate:!0,rotateRange:[-180,180],rotateSnap:!1,rotateSnapDist:0,scale:!0,scaleSnap:!1,scaleRange:!1,showBBox:!1,size:5},subject:e};a.updateHandles=function(){if(a.opts.showBBox||a.opts.dragRotate){var b,c=a.attrs.rotate*Math.PI/180,h=(a.attrs.rotate+90)*Math.PI/180,g=a.attrs.size.x/2*a.attrs.scale.x,d=a.attrs.size.y/2*a.attrs.scale.y,e=[];[{x:-1,y:-1},{x:1,y:-1},{x:1,y:1},{x:-1,y:1}].map(function(b){e.push({x:a.attrs.center.x+a.attrs.translate.x+b.x*g*Math.cos(c)+b.y*d*Math.cos(h),y:a.attrs.center.y+
a.attrs.translate.y+b.x*g*Math.sin(c)+b.y*d*Math.sin(h)})});b=e}var f={x:a.attrs.rotate*Math.PI/180,y:(a.attrs.rotate+90)*Math.PI/180},i={x:a.attrs.size.x/2*a.attrs.scale.x,y:a.attrs.size.y/2*a.attrs.scale.y};a.axes.map(function(c){if(a.handles[c]){var b=a.attrs.center.x+a.attrs.translate.x+i[c]*a.opts.distance*Math.cos(f[c]),h=a.attrs.center.y+a.attrs.translate.y+i[c]*a.opts.distance*Math.sin(f[c]);if(a.opts.boundary){b=Math.max(Math.min(b,a.opts.boundary.x+a.opts.boundary.width),a.opts.boundary.x);
h=Math.max(Math.min(h,a.opts.boundary.y+a.opts.boundary.height),a.opts.boundary.y)}a.handles[c].disc.attr({cx:b,cy:h});a.handles[c].line.toFront().attr({path:[["M",a.attrs.center.x+a.attrs.translate.x,a.attrs.center.y+a.attrs.translate.y],["L",a.handles[c].disc.attrs.cx,a.handles[c].disc.attrs.cy]]});a.handles[c].disc.toFront()}});a.handles.center&&a.handles.center.disc.toFront().attr({cx:a.attrs.center.x+a.attrs.translate.x,cy:a.attrs.center.y+a.attrs.translate.y});a.opts.showBBox&&a.bbox.toFront().attr({path:[["M",
b[0].x,b[0].y],["L",b[1].x,b[1].y],["L",b[2].x,b[2].y],["L",b[3].x,b[3].y],["L",b[0].x,b[0].y]]});if(a.opts.dragRotate){i=Math.max(Math.sqrt(Math.pow(b[1].x-b[0].x,2)+Math.pow(b[1].y-b[0].y,2)),Math.sqrt(Math.pow(b[2].x-b[1].x,2)+Math.pow(b[2].y-b[1].y,2)))/2;a.circle.attr({cx:a.attrs.center.x+a.attrs.translate.x,cy:a.attrs.center.y+a.attrs.translate.y,r:i*a.opts.distance})}};a.showHandles=function(){a.hideHandles();(a.opts.rotate||a.opts.scale)&&a.axes.map(function(c){a.handles[c]={};a.handles[c].line=
d.path(["M",a.attrs.center.x,a.attrs.center.y]).attr({stroke:a.opts.attrs.stroke,"stroke-dasharray":"- ",opacity:0.5});a.handles[c].disc=d.circle(a.attrs.center.x,a.attrs.center.y,a.opts.size).attr(a.opts.attrs)});if(a.opts.drag){a.handles.center={};a.handles.center.disc=d.circle(a.attrs.center.x,a.attrs.center.y,a.opts.size).attr(a.opts.attrs)}if(a.opts.showBBox)a.bbox=d.path("").attr({stroke:a.opts.attrs.stroke,"stroke-dasharray":"- ",opacity:0.5});if(a.opts.dragRotate||a.opts.dragScale)a.circle=
d.circle(0,0,0).attr({stroke:a.opts.attrs.stroke,"stroke-dasharray":"- ",opacity:0.3});a.axes.map(function(c){a.handles[c]&&a.handles[c].disc.drag(function(b,g){if(a.o.viewBoxRatio){b=b*a.o.viewBoxRatio.x;g=g*a.o.viewBoxRatio.y}var d=b+a.handles[c].disc.ox,e=g+a.handles[c].disc.oy,f={x:a.o.scale.x<0,y:a.o.scale.y<0};if(a.opts.rotate){var j=Math.atan2(e-a.o.center.y-a.o.translate.y,d-a.o.center.x-a.o.translate.x);a.attrs.rotate=j*180/Math.PI-(c=="y"?90:0);if(f[c])a.attrs.rotate=a.attrs.rotate-180}if(a.opts.boundary){d=
Math.max(Math.min(d,a.opts.boundary.x+a.opts.boundary.width),a.opts.boundary.x);e=Math.max(Math.min(e,a.opts.boundary.y+a.opts.boundary.height),a.opts.boundary.y)}d=Math.sqrt(Math.pow(d-a.o.center.x-a.o.translate.x,2)+Math.pow(e-a.o.center.y-a.o.translate.y,2));if(a.opts.scale){a.attrs.scale={x:c=="x"?d/(a.o.size.x/2*a.opts.distance):a.o.scale.x,y:c=="y"?d/(a.o.size.y/2*a.opts.distance):a.o.scale.y};f[c]&&(a.attrs.scale[c]=a.attrs.scale[c]*-1)}l();a.attrs.scale.x&&a.attrs.scale.y&&a.apply();i([a.opts.rotate?
"rotate":null,a.opts.scale?"scale":null])},function(){a.o=k(a.attrs);if(d._viewBox)a.o.viewBoxRatio={x:d._viewBox[2]/d.width,y:d._viewBox[3]/d.height};a.handles[c].disc.ox=this.attrs.cx;a.handles[c].disc.oy=this.attrs.cy;i([a.opts.rotate?"rotate start":null,a.opts.scale?"scale start":null])},function(){i([a.opts.rotate?"rotate end":null,a.opts.scale?"scale end":null])})});if(a.opts.drag){var b=[];!a.opts.dragRotate&&!a.opts.dragScale&&b.push(e);a.handles.center&&b.push(a.handles.center.disc);b.map(function(c){c.drag(function(c,
b){if(a.o.viewBoxRatio){c=c*a.o.viewBoxRatio.x;b=b*a.o.viewBoxRatio.y}a.attrs.translate.x=a.o.translate.x+c;a.attrs.translate.y=a.o.translate.y+b;var d=k(a.o.bbox);d.x=d.x+c;d.y=d.y+b;l(d);a.apply();i(["drag"])},function(){a.o=k(a.attrs);if(a.opts.dragSnap)a.o.bbox=e.getBBox();if(d._viewBox)a.o.viewBoxRatio={x:d._viewBox[2]/d.width,y:d._viewBox[3]/d.height};a.axes.map(function(c){if(a.handles[c]){a.handles[c].disc.ox=a.handles[c].disc.attrs.cx;a.handles[c].disc.oy=a.handles[c].disc.attrs.cy}});i(["drag start"])},
function(){i(["drag end"])})})}(a.opts.dragRotate||a.opts.dragScale)&&e.drag(function(c,b,d,e){if(a.opts.dragRotate){c=Math.atan2(e-a.o.center.y-a.o.translate.y,d-a.o.center.x-a.o.translate.x);a.attrs.rotate=a.o.rotate+c*180/Math.PI-a.o.deg}c=a.o.scale.x<0;b=a.o.scale.y<0;if(a.opts.dragScale){d=Math.sqrt(Math.pow(d-a.o.center.x-a.o.translate.x,2)+Math.pow(e-a.o.center.y-a.o.translate.y,2));a.attrs.scale.x=a.attrs.scale.y=(c?-1:1)*a.o.scale.x+(d-a.o.radius)/(a.o.size.x/2);if(c)a.attrs.scale.x=a.attrs.scale.x*
-1;if(b)a.attrs.scale.y=a.attrs.scale.y*-1}l();a.apply();i([a.opts.dragRotate?"rotate":null,a.opts.dragScale?"scale":null])},function(c,b){a.o=k(a.attrs);a.o.deg=Math.atan2(b-a.o.center.y-a.o.translate.y,c-a.o.center.x-a.o.translate.x)*180/Math.PI;a.o.radius=Math.sqrt(Math.pow(c-a.o.center.x-a.o.translate.x,2)+Math.pow(b-a.o.center.y-a.o.translate.y,2));if(d._viewBox)a.o.viewBoxRatio={x:d._viewBox[2]/d.width,y:d._viewBox[3]/d.height};i([a.opts.dragRotate?"rotate start":null,a.opts.dragScale?"scale start":
null])},function(){i([a.opts.dragRotate?"rotate end":null,a.opts.dragScale?"scale end":null])});a.updateHandles()};a.hideHandles=function(){a.items.map(function(a){a.el.undrag()});if(a.handles.center){a.handles.center.disc.remove();a.handles.center=null}["x","y"].map(function(b){if(a.handles[b]){a.handles[b].disc.remove();a.handles[b].line.remove();a.handles[b]=null}});if(a.bbox){a.bbox.remove();a.bbox=null}if(a.circle){a.circle.remove();a.circle=null}};a.setOpts=function(b,c){a.callback=typeof c==
"function"?c:false;for(var d in b)a.opts[d]=b[d];if(!a.opts.scale)a.opts.keepRatio=true;a.axes=a.opts.keepRatio?["y"]:["x","y"];if(!a.opts.dragSnapDist)a.opts.dragSnapDist=a.opts.dragSnap;if(!a.opts.rotateSnapDist)a.opts.rotateSnapDist=a.opts.rotateSnap;a.opts.rotateRange=[parseInt(a.opts.rotateRange[0]),parseInt(a.opts.rotateRange[1])];a.showHandles();i(["init"])};a.setOpts(m,n);a.apply=function(){a.items.map(function(b,c){var d=a.attrs.center.x+a.offset.translate.x,e=a.attrs.center.y+a.offset.translate.y,
i=a.attrs.rotate-a.offset.rotate;scale={x:a.attrs.scale.x/a.offset.scale.x,y:a.attrs.scale.y/a.offset.scale.y};translate={x:a.attrs.translate.x-a.offset.translate.x,y:a.attrs.translate.y-a.offset.translate.y};b.el.transform(["R",i,d,e,"S",scale.x,scale.y,d,e,"T",translate.x,translate.y]+a.items[c].transformString)});a.updateHandles()};a.unplug=function(){var b=a.attrs;a.hideHandles();delete e.freeTransform;return b};("set"==e.type?e.items:[e]).map(function(b){a.items.push({el:b,attrs:{rotate:0,scale:{x:1,
y:1},translate:{x:0,y:0}},transformString:b.matrix.toTransformString()})});a.items.map(function(b,c){b.el._&&b.el._.transform&&b.el._.transform.map(function(b){if(b[0])switch(b[0].toUpperCase()){case "T":a.items[c].attrs.translate.x=a.items[c].attrs.translate.x+b[1];a.items[c].attrs.translate.y=a.items[c].attrs.translate.y+b[2];break;case "S":a.items[c].attrs.scale.x=a.items[c].attrs.scale.x*b[1];a.items[c].attrs.scale.y=a.items[c].attrs.scale.y*b[2];break;case "R":a.items[c].attrs.rotate=a.items[c].attrs.rotate+
b[1]}})});"set"!=e.type&&(a.attrs.rotate=a.items[0].attrs.rotate,a.attrs.scale=a.items[0].attrs.scale,a.attrs.translate=a.items[0].attrs.translate,a.items[0].attrs={rotate:0,scale:{x:1,y:1},translate:{x:0,y:0}},a.items[0].transformString="");var o=!1;a.updateHandles();return a};
